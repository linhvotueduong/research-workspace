<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ResearchOS ‚Äî Literature Review Workspace</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Mono:ital,wght@0,300;0,400;0,500;1,300&family=Fraunces:ital,opsz,wght@0,9..144,300;0,9..144,600;1,9..144,300&family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,400;0,9..40,500;1,9..40,300&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0f0f13;
    --surface: #17171f;
    --surface2: #1e1e2a;
    --surface3: #252535;
    --border: #2a2a3d;
    --border2: #353548;
    --text: #e8e8f0;
    --text2: #9090a8;
    --text3: #5a5a72;
    --accent: #7c6af7;
    --accent2: #a594ff;
    --green: #4caf8a;
    --orange: #e8834a;
    --pink: #e06b8b;
    --teal: #4ab8c8;
    --yellow: #d4b84a;
    --red: #e05a5a;
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { font-family: 'DM Sans', sans-serif; background: var(--bg); color: var(--text); height: 100vh; display: flex; flex-direction: column; overflow: hidden; font-size: 13px; }
  .topnav { background: var(--surface); border-bottom: 1px solid var(--border); display: flex; align-items: center; padding: 0 16px; height: 44px; flex-shrink: 0; gap: 2px; }
  .logo { font-family: 'Fraunces', serif; font-size: 16px; font-weight: 600; color: var(--accent2); margin-right: 20px; letter-spacing: -0.3px; }
  .logo span { color: var(--text3); font-weight: 300; font-style: italic; }
  .nav-tab { padding: 6px 12px; border-radius: 6px; cursor: pointer; color: var(--text2); font-size: 12.5px; font-weight: 400; transition: all 0.15s; border: none; background: none; white-space: nowrap; }
  .nav-tab:hover { background: var(--surface2); color: var(--text); }
  .nav-tab.active { background: var(--surface3); color: var(--text); }
  .toolbar { background: var(--surface); border-bottom: 1px solid var(--border); display: flex; align-items: center; padding: 6px 12px; gap: 4px; flex-shrink: 0; height: 52px; overflow-x: auto; }
  .toolbar-btn { display: flex; flex-direction: column; align-items: center; gap: 3px; padding: 5px 10px; border-radius: 8px; cursor: pointer; border: none; background: none; color: var(--text2); transition: all 0.15s; white-space: nowrap; min-width: 52px; }
  .toolbar-btn:hover { background: var(--surface2); color: var(--text); }
  .toolbar-btn.active { background: var(--accent)22; color: var(--accent2); }
  .toolbar-btn .icon { font-size: 18px; line-height: 1; }
  .toolbar-btn .label { font-size: 10px; font-weight: 400; }
  .toolbar-sep { width: 1px; height: 30px; background: var(--border); margin: 0 4px; flex-shrink: 0; }
  .main { display: grid; grid-template-columns: 240px 1fr 280px; flex: 1; overflow: hidden; }
  .panel { border-right: 1px solid var(--border); display: flex; flex-direction: column; overflow: hidden; }
  .panel-header { padding: 8px 12px; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; background: var(--surface); flex-shrink: 0; }
  .panel-title { font-size: 11px; font-weight: 500; color: var(--text2); text-transform: uppercase; letter-spacing: 0.8px; font-family: 'DM Mono', monospace; }
  .panel-actions { display: flex; gap: 4px; }
  .icon-btn { width: 22px; height: 22px; border-radius: 5px; border: none; background: none; cursor: pointer; color: var(--text3); display: flex; align-items: center; justify-content: center; font-size: 14px; transition: all 0.1s; }
  .icon-btn:hover { background: var(--surface3); color: var(--text); }
  .panel-search { padding: 8px 12px; border-bottom: 1px solid var(--border); flex-shrink: 0; }
  .search-input { width: 100%; background: var(--surface2); border: 1px solid var(--border); border-radius: 6px; padding: 5px 10px; color: var(--text); font-size: 12px; font-family: 'DM Sans', sans-serif; outline: none; transition: border-color 0.15s; }
  .search-input:focus { border-color: var(--accent); }
  .search-input::placeholder { color: var(--text3); }
  .panel-scroll { overflow-y: auto; flex: 1; }
  .doc-item { padding: 8px 12px; border-bottom: 1px solid var(--border)44; cursor: pointer; display: flex; align-items: center; gap: 8px; transition: background 0.1s; }
  .doc-item:hover { background: var(--surface2); }
  .doc-item.active { background: var(--accent)15; border-left: 2px solid var(--accent); padding-left: 10px; }
  .doc-icon { font-size: 14px; flex-shrink: 0; }
  .doc-info { flex: 1; overflow: hidden; }
  .doc-name { font-size: 12px; color: var(--text); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .doc-meta { font-size: 10px; color: var(--text3); margin-top: 1px; font-family: 'DM Mono', monospace; }
  .doc-count { font-size: 10px; font-family: 'DM Mono', monospace; color: var(--accent2); background: var(--accent)22; padding: 1px 6px; border-radius: 10px; flex-shrink: 0; }
  .set-header { padding: 6px 12px; display: flex; align-items: center; gap: 6px; cursor: pointer; background: var(--surface2); border-bottom: 1px solid var(--border); }
  .set-arrow { font-size: 10px; color: var(--text3); transition: transform 0.15s; }
  .set-arrow.open { transform: rotate(90deg); }
  .set-name { font-size: 11px; font-weight: 500; color: var(--text2); flex: 1; }
  .set-dot { width: 8px; height: 8px; border-radius: 2px; background: var(--orange); }
  .doc-viewer { flex: 1; overflow: hidden; display: flex; flex-direction: column; background: var(--bg); }
  .viewer-toolbar { background: var(--surface); border-bottom: 1px solid var(--border); padding: 6px 12px; display: flex; align-items: center; gap: 8px; flex-shrink: 0; }
  .code-badge { background: var(--surface2); border: 1px solid var(--border2); border-radius: 5px; padding: 3px 10px; font-size: 11px; color: var(--text2); font-family: 'DM Mono', monospace; cursor: pointer; white-space: nowrap; max-width: 220px; overflow: hidden; text-overflow: ellipsis; }
  .viewer-content { flex: 1; overflow-y: auto; padding: 28px 40px; line-height: 1.75; }
  .viewer-content h1 { font-family: 'Fraunces', serif; font-size: 22px; font-weight: 600; color: var(--text); margin-bottom: 12px; letter-spacing: -0.3px; }
  .viewer-content h2 { font-family: 'Fraunces', serif; font-size: 17px; font-weight: 600; color: var(--text); margin: 24px 0 10px; }
  .viewer-content p { color: var(--text2); font-size: 13.5px; margin-bottom: 14px; }
  .highlight { background: var(--accent)33; border-left: 2px solid var(--accent2); padding: 1px 3px; border-radius: 2px; cursor: pointer; }
  .highlight.green { background: var(--green)25; border-left-color: var(--green); }
  .highlight.orange { background: var(--orange)25; border-left-color: var(--orange); }
  .right-panel { border-left: 1px solid var(--border); border-right: none; display: flex; flex-direction: column; overflow: hidden; }
  .code-item { padding: 7px 12px; border-bottom: 1px solid var(--border)33; cursor: pointer; display: flex; align-items: center; gap: 8px; transition: background 0.1s; }
  .code-item:hover { background: var(--surface2); }
  .code-item.sub { padding-left: 26px; }
  .code-dot { width: 9px; height: 9px; border-radius: 3px; flex-shrink: 0; }
  .code-name { font-size: 12px; color: var(--text); flex: 1; }
  .code-n { font-size: 10px; font-family: 'DM Mono', monospace; color: var(--text3); }
  .code-item.active { background: var(--accent)15; }
  .code-item.active .code-name { color: var(--accent2); }
  .memo-area { background: var(--surface); border-top: 1px solid var(--border); flex-shrink: 0; }
  .memo-header { padding: 8px 12px; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; }
  .memo-title { font-size: 11px; font-weight: 500; color: var(--text2); text-transform: uppercase; letter-spacing: 0.6px; font-family: 'DM Mono', monospace; }
  textarea.memo-input { width: 100%; background: var(--surface); border: none; color: var(--text); font-family: 'DM Sans', sans-serif; font-size: 12.5px; line-height: 1.6; padding: 10px 12px; resize: none; height: 90px; outline: none; }
  textarea.memo-input::placeholder { color: var(--text3); }
  .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.6); display: flex; align-items: center; justify-content: center; z-index: 100; backdrop-filter: blur(4px); opacity: 0; pointer-events: none; transition: opacity 0.2s; }
  .modal-overlay.open { opacity: 1; pointer-events: all; }
  .modal { background: var(--surface); border: 1px solid var(--border2); border-radius: 14px; padding: 24px; width: 480px; max-width: 90vw; box-shadow: 0 20px 60px rgba(0,0,0,0.5); transform: translateY(10px); transition: transform 0.2s; }
  .modal-overlay.open .modal { transform: translateY(0); }
  .modal h3 { font-family: 'Fraunces', serif; font-size: 18px; margin-bottom: 16px; color: var(--text); }
  .modal input, .modal textarea, .modal select { width: 100%; background: var(--surface2); border: 1px solid var(--border2); border-radius: 8px; padding: 9px 12px; color: var(--text); font-family: 'DM Sans', sans-serif; font-size: 13px; outline: none; margin-bottom: 10px; transition: border-color 0.15s; }
  .modal input:focus, .modal textarea:focus, .modal select:focus { border-color: var(--accent); }
  .modal textarea { resize: vertical; min-height: 80px; }
  .modal select option { background: var(--surface2); }
  .modal label { font-size: 11px; color: var(--text3); margin-bottom: 4px; display: block; text-transform: uppercase; letter-spacing: 0.5px; }
  .btn-row { display: flex; gap: 8px; justify-content: flex-end; margin-top: 8px; }
  .btn { padding: 8px 18px; border-radius: 8px; font-size: 13px; font-weight: 500; cursor: pointer; border: none; transition: all 0.15s; font-family: 'DM Sans', sans-serif; }
  .btn-primary { background: var(--accent); color: white; }
  .btn-primary:hover { background: var(--accent2); }
  .btn-ghost { background: var(--surface2); color: var(--text2); }
  .btn-ghost:hover { background: var(--surface3); color: var(--text); }
  .panel-tabs { display: flex; border-bottom: 1px solid var(--border); background: var(--surface); flex-shrink: 0; }
  .panel-tab { flex: 1; padding: 8px 4px; text-align: center; font-size: 11px; font-weight: 500; color: var(--text3); cursor: pointer; border-bottom: 2px solid transparent; transition: all 0.15s; }
  .panel-tab:hover { color: var(--text2); }
  .panel-tab.active { color: var(--accent2); border-bottom-color: var(--accent); }
  .segment { padding: 10px 12px; border-bottom: 1px solid var(--border)33; cursor: pointer; transition: background 0.1s; }
  .segment:hover { background: var(--surface2); }
  .segment-text { font-size: 12px; color: var(--text2); line-height: 1.5; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
  .segment-meta { font-size: 10px; color: var(--text3); margin-top: 4px; font-family: 'DM Mono', monospace; display: flex; gap: 6px; align-items: center; flex-wrap: wrap; }
  .segment-code-tag { display: inline-block; padding: 1px 6px; border-radius: 10px; font-size: 10px; font-family: 'DM Mono', monospace; }
  .toast { position: fixed; bottom: 20px; right: 20px; background: var(--surface3); border: 1px solid var(--border2); border-radius: 10px; padding: 10px 16px; font-size: 13px; color: var(--text); z-index: 200; opacity: 0; transform: translateY(10px); transition: all 0.3s; pointer-events: none; }
  .toast.show { opacity: 1; transform: translateY(0); }
  .statusbar { background: var(--surface); border-top: 1px solid var(--border); padding: 3px 12px; display: flex; align-items: center; gap: 16px; flex-shrink: 0; }
  .status-item { font-size: 10.5px; font-family: 'DM Mono', monospace; color: var(--text3); display: flex; align-items: center; gap: 4px; }
  .status-dot { width: 6px; height: 6px; border-radius: 50%; background: var(--green); }
  ::-webkit-scrollbar { width: 4px; height: 4px; }
  ::-webkit-scrollbar-track { background: transparent; }
  ::-webkit-scrollbar-thumb { background: var(--border2); border-radius: 4px; }
  .c-purple { background: var(--accent); } .c-green { background: var(--green); } .c-orange { background: var(--orange); } .c-pink { background: var(--pink); } .c-teal { background: var(--teal); } .c-yellow { background: var(--yellow); }
  .sel-toolbar { position: fixed; background: var(--surface3); border: 1px solid var(--border2); border-radius: 8px; padding: 4px 6px; display: none; gap: 4px; z-index: 50; box-shadow: 0 4px 20px rgba(0,0,0,0.4); }
  .sel-toolbar.show { display: flex; }
  .sel-btn { padding: 4px 10px; border-radius: 5px; border: none; font-size: 11px; font-weight: 500; cursor: pointer; transition: opacity 0.1s; font-family: 'DM Sans', sans-serif; }
  .sel-btn:hover { opacity: 0.8; }
  .color-options { display: flex; gap: 6px; margin-bottom: 10px; }
  .color-opt { width: 22px; height: 22px; border-radius: 5px; cursor: pointer; border: 2px solid transparent; transition: border-color 0.1s; }
  .color-opt.selected { border-color: white; }
  .empty { text-align: center; padding: 40px 20px; color: var(--text3); font-size: 12px; line-height: 1.6; }
  .empty .emoji { font-size: 28px; margin-bottom: 8px; }
  .analysis-card { background: var(--surface2); border: 1px solid var(--border); border-radius: 10px; padding: 14px; margin: 10px; }
  .analysis-title { font-size: 12px; font-weight: 500; color: var(--text2); margin-bottom: 10px; display: flex; align-items: center; gap: 6px; }
  .bar-row { display: flex; align-items: center; gap: 8px; margin-bottom: 6px; }
  .bar-label { font-size: 11px; color: var(--text2); width: 100px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
  .bar-track { flex: 1; height: 6px; background: var(--surface3); border-radius: 10px; overflow: hidden; }
  .bar-fill { height: 100%; border-radius: 10px; transition: width 0.5s ease; }
  .bar-count { font-size: 10px; font-family: 'DM Mono', monospace; color: var(--text3); width: 20px; text-align: right; }
  /* REPORT */
  #report-view { background: var(--bg); }
  .report-section { margin-bottom: 40px; }
  .report-claim { font-family: 'Fraunces', serif; font-size: 17px; font-weight: 600; color: var(--text); margin-bottom: 6px; padding-bottom: 8px; border-bottom: 2px solid var(--border); display: flex; align-items: center; gap: 10px; }
  .report-claim-dot { width: 12px; height: 12px; border-radius: 3px; flex-shrink: 0; }
  .report-code-desc { font-size: 12.5px; color: var(--text3); margin-bottom: 16px; font-style: italic; }
  .seg-card { background: var(--surface); border: 1px solid var(--border); border-radius: 10px; margin-bottom: 14px; overflow: hidden; }
  .seg-card-header { padding: 8px 14px; background: var(--surface2); border-bottom: 1px solid var(--border); display: flex; align-items: center; gap: 8px; font-size: 11px; font-family: 'DM Mono', monospace; color: var(--text3); flex-wrap: wrap; }
  .seg-type-badge { padding: 2px 8px; border-radius: 10px; font-size: 10px; font-weight: 500; text-transform: uppercase; letter-spacing: 0.5px; }
  .seg-quote { padding: 12px 14px; font-style: italic; color: var(--text2); font-size: 13px; line-height: 1.65; border-left: 3px solid var(--accent); margin: 12px 14px; background: var(--surface2); border-radius: 0 8px 8px 0; }
  .seg-quote.green { border-left-color: var(--green); }
  .seg-quote.orange { border-left-color: var(--orange); }
  .seg-note { padding: 10px 14px 12px; font-size: 13px; color: var(--text); line-height: 1.6; }
  .seg-note-label { font-size: 10px; font-family: 'DM Mono', monospace; color: var(--text3); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px; }
  .report-matrix-table { width: 100%; border-collapse: collapse; font-size: 12px; margin-top: 12px; }
  .report-matrix-table th { background: var(--surface2); padding: 8px 10px; text-align: left; font-size: 10px; font-family: 'DM Mono', monospace; color: var(--text2); border: 1px solid var(--border); font-weight: 500; letter-spacing: 0.5px; }
  .report-matrix-table td { padding: 8px 10px; border: 1px solid var(--border); color: var(--text2); vertical-align: top; line-height: 1.55; }
  .report-matrix-table tr:hover td { background: var(--surface2)88; }
  .report-matrix-table .claim-cell { font-weight: 500; color: var(--text); background: var(--surface)88; font-size: 11px; }
  .report-h1 { font-family: 'Fraunces', serif; font-size: 24px; font-weight: 600; color: var(--text); margin-bottom: 6px; letter-spacing: -0.5px; }
  .report-meta { font-size: 11px; color: var(--text3); font-family: 'DM Mono', monospace; margin-bottom: 28px; padding-bottom: 16px; border-bottom: 1px solid var(--border); }
  .report-section-heading { font-family: 'Fraunces', serif; font-size: 15px; font-weight: 600; color: var(--text2); margin: 24px 0 10px; padding-bottom: 6px; border-bottom: 1px solid var(--border); }
  .memo-card { background: var(--surface); border: 1px solid var(--border); border-radius: 10px; padding: 14px; margin-bottom: 12px; }
  .memo-card-title { font-weight: 500; font-size: 13px; color: var(--text); margin-bottom: 6px; }
  .memo-card-body { font-size: 12.5px; color: var(--text2); line-height: 1.6; }
  .no-segs-notice { color: var(--text3); font-size: 12px; font-style: italic; padding: 10px 0; }
  /* drop zone */
  #drop-zone { border: 2px dashed var(--border2); border-radius: 12px; padding: 28px 20px; text-align: center; cursor: pointer; margin-bottom: 14px; transition: border-color 0.2s, background 0.2s; }
  #drop-zone:hover { border-color: var(--accent); }
</style>
</head>
<body>

<nav class="topnav">
  <div class="logo">Research<span>OS</span></div>
  <button class="nav-tab active" onclick="switchNav(this,'import')">Import</button>
  <button class="nav-tab" onclick="switchNav(this,'codes')">Codes</button>
  <button class="nav-tab" onclick="switchNav(this,'memos')">Memos</button>
  <button class="nav-tab" onclick="switchNav(this,'analysis')">Analysis</button>
  <button class="nav-tab" onclick="switchNav(this,'visual')">Visual Tools</button>
  <button class="nav-tab" onclick="switchNav(this,'reports')">Reports</button>
</nav>

<div class="toolbar" id="toolbar-import">
  <button class="toolbar-btn" onclick="triggerFileImport()"><span class="icon">üìÑ</span><span class="label">Texts/PDFs</span></button>
  <button class="toolbar-btn" onclick="openModal('importWeb')"><span class="icon">üåê</span><span class="label">Web/URL</span></button>
  <div class="toolbar-sep"></div>
  <button class="toolbar-btn active" onclick="openModal('newDoc')"><span class="icon">‚úçÔ∏è</span><span class="label">New Doc</span></button>
  <button class="toolbar-btn" onclick="openModal('importWeb')"><span class="icon">üìÇ</span><span class="label">Any File</span></button>
</div>
<input type="file" id="file-input" style="display:none" multiple accept=".pdf,.txt,.md,.docx,.csv,.rtf" onchange="handleFileImport(this.files)">

<div class="toolbar" id="toolbar-codes" style="display:none">
  <button class="toolbar-btn active"><span class="icon">üé®</span><span class="label">Creative</span></button>
  <button class="toolbar-btn"><span class="icon">ü§ñ</span><span class="label">Smart Code</span></button>
  <div class="toolbar-sep"></div>
  <button class="toolbar-btn" onclick="openModal('addCode')"><span class="icon">‚ûï</span><span class="label">Add Code</span></button>
  <button class="toolbar-btn" onclick="exportReportMD()"><span class="icon">üì§</span><span class="label">Export</span></button>
</div>

<div class="toolbar" id="toolbar-memos" style="display:none">
  <button class="toolbar-btn active" onclick="openModal('newMemo')"><span class="icon">üìù</span><span class="label">New Memo</span></button>
  <button class="toolbar-btn"><span class="icon">üìã</span><span class="label">All Memos</span></button>
</div>

<div class="toolbar" id="toolbar-analysis" style="display:none">
  <button class="toolbar-btn active"><span class="icon">üîç</span><span class="label">Text Search</span></button>
  <button class="toolbar-btn"><span class="icon">üìä</span><span class="label">Summary Grid</span></button>
  <button class="toolbar-btn"><span class="icon">üìà</span><span class="label">Code Freq.</span></button>
</div>

<div class="toolbar" id="toolbar-visual" style="display:none">
  <button class="toolbar-btn active"><span class="icon">üó∫Ô∏è</span><span class="label">MAXMaps</span></button>
  <button class="toolbar-btn"><span class="icon">‚òÅÔ∏è</span><span class="label">Word Cloud</span></button>
</div>

<div class="toolbar" id="toolbar-reports" style="display:none">
  <button class="toolbar-btn active" onclick="showReportView('matrix')"><span class="icon">üìä</span><span class="label">Findings Matrix</span></button>
  <button class="toolbar-btn" onclick="showReportView('bycode')"><span class="icon">üè∑Ô∏è</span><span class="label">By Code</span></button>
  <button class="toolbar-btn" onclick="showReportView('bydoc')"><span class="icon">üìÑ</span><span class="label">By Document</span></button>
  <button class="toolbar-btn" onclick="showReportView('memos')"><span class="icon">üìù</span><span class="label">Memos</span></button>
  <div class="toolbar-sep"></div>
  <button class="toolbar-btn" onclick="exportReportHTML()"><span class="icon">üñ®Ô∏è</span><span class="label">Print/PDF</span></button>
  <button class="toolbar-btn" onclick="exportReportMD()"><span class="icon">üì§</span><span class="label">Export .md</span></button>
</div>

<!-- REPORT VIEW -->
<div id="report-view" style="display:none;flex:1;overflow:hidden;flex-direction:column;">
  <div style="background:var(--surface);border-bottom:1px solid var(--border);padding:10px 20px;display:flex;align-items:center;gap:12px;flex-shrink:0;">
    <span style="font-size:11px;color:var(--text3);font-family:'DM Mono',monospace;" id="report-view-title">FINDINGS MATRIX</span>
    <div style="flex:1"></div>
    <span style="font-size:11px;color:var(--text3);" id="report-counts"></span>
    <button onclick="closeReportView()" style="background:var(--surface3);border:none;color:var(--text2);padding:4px 12px;border-radius:6px;cursor:pointer;font-size:12px;font-family:'DM Sans',sans-serif;">‚Üê Back to Editor</button>
  </div>
  <div id="report-content" style="flex:1;overflow-y:auto;padding:28px 36px;background:var(--bg);"></div>
</div>

<!-- MAIN -->
<div class="main" id="main-layout">
  <!-- LEFT: Documents -->
  <div class="panel">
    <div class="panel-header">
      <span class="panel-title">Documents</span>
      <div class="panel-actions">
        <button class="icon-btn" onclick="openModal('newDoc')" title="Add">Ôºã</button>
        <button class="icon-btn" onclick="triggerFileImport()" title="Import">üìÇ</button>
      </div>
    </div>
    <div class="panel-search">
      <input class="search-input" type="text" placeholder="Search documents‚Ä¶" oninput="filterDocs(this.value)">
    </div>
    <div class="panel-scroll" id="doc-list"></div>
  </div>

  <!-- CENTER: Document Viewer -->
  <div class="doc-viewer">
    <div class="viewer-toolbar">
      <span style="font-size:11px;color:var(--text3);font-family:'DM Mono',monospace;flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;" id="viewer-doc-label">No document selected</span>
      <div class="code-badge" id="active-code-badge" onclick="openModal('addCode')">+ Apply Code</div>
    </div>
    <div class="viewer-content" id="viewer-content" onmouseup="handleSelection(event)">
      <div class="empty" id="viewer-empty">
        <div class="emoji">üìö</div>
        Select a document to start reading and coding.<br><br>
        <small>Highlight any text ‚Üí choose Code / Quote / Mark</small>
      </div>
    </div>
  </div>

  <!-- RIGHT: Codes + Segments -->
  <div class="right-panel">
    <div class="panel-tabs">
      <div class="panel-tab active" onclick="switchRightTab(this,'codes')">Codes</div>
      <div class="panel-tab" onclick="switchRightTab(this,'segments')">Segments</div>
      <div class="panel-tab" onclick="switchRightTab(this,'memos')">Memos</div>
      <div class="panel-tab" onclick="switchRightTab(this,'analysis')">Analysis</div>
    </div>

    <div id="right-codes" style="display:flex;flex-direction:column;flex:1;overflow:hidden;">
      <div class="panel-header">
        <span class="panel-title">Code System</span>
        <button class="icon-btn" onclick="openModal('addCode')">Ôºã</button>
      </div>
      <div class="panel-scroll" id="code-list"></div>
      <div class="memo-area">
        <div class="memo-header">
          <span class="memo-title">Code Memo</span>
          <button class="icon-btn" onclick="saveCodeMemo()">üíæ</button>
        </div>
        <textarea class="memo-input" id="code-memo-input" placeholder="Notes about selected code‚Ä¶"></textarea>
      </div>
    </div>

    <div id="right-segments" style="display:none;flex-direction:column;flex:1;overflow:hidden;">
      <div class="panel-header"><span class="panel-title">Coded Segments</span></div>
      <div class="panel-scroll" id="segments-list"></div>
    </div>

    <div id="right-memos" style="display:none;flex-direction:column;flex:1;overflow:hidden;">
      <div class="panel-header">
        <span class="panel-title">Memos</span>
        <button class="icon-btn" onclick="openModal('newMemo')">Ôºã</button>
      </div>
      <div class="panel-scroll" id="memos-list"></div>
    </div>

    <div id="right-analysis" style="display:none;flex-direction:column;flex:1;overflow:hidden;">
      <div class="panel-scroll" id="analysis-content"></div>
    </div>
  </div>
</div>

<!-- STATUS BAR -->
<div class="statusbar">
  <div class="status-item"><span class="status-dot"></span><span id="st-docs">0 documents</span></div>
  <div class="status-item">üìå <span id="st-codes">0 codes</span></div>
  <div class="status-item">‚úÇÔ∏è <span id="st-segments">0 segments</span></div>
  <div class="status-item">üìù <span id="st-memos">0 memos</span></div>
  <div style="flex:1"></div>
  <div class="status-item" style="color:var(--accent2)">ResearchOS</div>
</div>

<!-- SELECTION TOOLBAR -->
<div class="sel-toolbar" id="sel-toolbar">
  <button class="sel-btn" style="background:var(--accent);color:white;" onclick="applyHighlight('purple')">üè∑ Code</button>
  <button class="sel-btn" style="background:var(--green);color:white;" onclick="applyHighlight('green')">üí¨ Quote</button>
  <button class="sel-btn" style="background:var(--orange);color:white;" onclick="applyHighlight('orange')">üìå Mark</button>
  <button class="sel-btn" style="background:var(--surface3);color:var(--text2);" onclick="hideSelToolbar()">‚úï</button>
</div>

<!-- SEGMENT ANNOTATION POPUP -->
<div id="seg-popup" style="position:fixed;z-index:60;display:none;background:var(--surface);border:1px solid var(--border2);border-radius:12px;padding:14px;width:320px;box-shadow:0 8px 32px rgba(0,0,0,0.5);">
  <div style="font-size:11px;color:var(--text3);margin-bottom:6px;font-family:'DM Mono',monospace;">ANNOTATE SEGMENT</div>
  <div id="seg-popup-quote" style="background:var(--surface2);border-left:3px solid var(--accent);padding:7px 10px;border-radius:6px;font-size:12px;color:var(--text2);margin-bottom:10px;line-height:1.5;max-height:60px;overflow:hidden;font-style:italic;"></div>
  <textarea id="seg-popup-note" rows="3" placeholder="Your note, paraphrase, or synthesis‚Ä¶" style="width:100%;background:var(--surface2);border:1px solid var(--border2);border-radius:8px;padding:8px 10px;color:var(--text);font-family:'DM Sans',sans-serif;font-size:12.5px;resize:none;outline:none;line-height:1.5;margin-bottom:8px;"></textarea>
  <div style="display:flex;gap:6px;align-items:center;">
    <select id="seg-popup-type" style="background:var(--surface2);border:1px solid var(--border2);border-radius:7px;padding:5px 8px;color:var(--text2);font-size:11.5px;font-family:'DM Sans',sans-serif;outline:none;flex:1;">
      <option value="quote">Direct Quote</option>
      <option value="paraphrase">Paraphrase</option>
      <option value="synthesis">Synthesis Note</option>
      <option value="figure">Figure / Data</option>
      <option value="counter">Counter-evidence</option>
    </select>
    <button onclick="confirmSegment()" style="background:var(--accent);color:white;border:none;border-radius:8px;padding:6px 14px;font-size:12.5px;font-weight:500;cursor:pointer;font-family:'DM Sans',sans-serif;">Save</button>
    <button onclick="cancelSegment()" style="background:var(--surface3);color:var(--text2);border:none;border-radius:8px;padding:6px 10px;font-size:12.5px;cursor:pointer;font-family:'DM Sans',sans-serif;">‚úï</button>
  </div>
</div>

<!-- MODALS -->
<div class="modal-overlay" id="modal-newDoc">
  <div class="modal">
    <h3>Add Document</h3>
    <label>Title / Citation</label>
    <input type="text" id="new-doc-title" placeholder="e.g., Smith et al. (2023) ‚Äî Title">
    <label>Content / Abstract</label>
    <textarea id="new-doc-content" rows="5" placeholder="Paste text here‚Ä¶"></textarea>
    <label>Type</label>
    <select id="new-doc-type">
      <option value="pdf">üìÑ Journal Article</option>
      <option value="web">üåê Web Source</option>
      <option value="book">üìö Book / Chapter</option>
      <option value="note">üìù Research Note</option>
    </select>
    <label>Set / Group</label>
    <select id="new-doc-set"><option value="">‚Äî No Set ‚Äî</option></select>
    <div class="btn-row">
      <button class="btn btn-ghost" onclick="closeModal('newDoc')">Cancel</button>
      <button class="btn btn-primary" onclick="addDocument()">Add Document</button>
    </div>
  </div>
</div>

<div class="modal-overlay" id="modal-fileImport">
  <div class="modal" style="width:500px">
    <h3>Import Documents</h3>
    <div id="drop-zone" onclick="document.getElementById('file-input').click()" ondragover="dropZoneDrag(event,true)" ondragleave="dropZoneDrag(event,false)" ondrop="dropZoneDrop(event)">
      <div style="font-size:32px;margin-bottom:8px;">üìÇ</div>
      <div style="font-size:14px;color:var(--text);margin-bottom:4px;font-weight:500;">Drop files here or click to browse</div>
      <div style="font-size:12px;color:var(--text3)">Supports: .pdf ¬∑ .txt ¬∑ .md ¬∑ .rtf ¬∑ .csv</div>
    </div>
    <div id="import-file-list" style="max-height:150px;overflow-y:auto;margin-bottom:10px;"></div>
    <label>Assign to Set</label>
    <select id="import-file-set"><option value="">‚Äî No Set ‚Äî</option></select>
    <div style="background:var(--surface2);border:1px solid var(--border);border-radius:8px;padding:8px 12px;margin-top:8px;font-size:11px;color:var(--text3);">
      ‚ö†Ô∏è <strong style="color:var(--text2)">PDFs:</strong> Text extraction requires conversion first. Use <a href="https://www.ilovepdf.com/pdf_to_word" target="_blank" style="color:var(--accent2)">ilovepdf.com</a> to convert, or paste text manually after import.
    </div>
    <div class="btn-row" style="margin-top:12px">
      <button class="btn btn-ghost" onclick="closeModal('fileImport');clearImportQueue()">Cancel</button>
      <button class="btn btn-primary" onclick="confirmFileImport()">Import All</button>
    </div>
  </div>
</div>

<div class="modal-overlay" id="modal-importWeb">
  <div class="modal">
    <h3>Import from URL / Web</h3>
    <label>URL</label>
    <input type="text" id="web-import-url" placeholder="https://‚Ä¶">
    <label>Title / Citation</label>
    <input type="text" id="web-import-title" placeholder="Author (Year) ‚Äî Title">
    <label>Paste relevant text</label>
    <textarea id="web-import-content" rows="5" placeholder="Copy and paste the content you want to analyse‚Ä¶"></textarea>
    <label>Set</label>
    <select id="web-import-set"><option value="">‚Äî No Set ‚Äî</option></select>
    <div class="btn-row">
      <button class="btn btn-ghost" onclick="closeModal('importWeb')">Cancel</button>
      <button class="btn btn-primary" onclick="importFromWeb()">Save Reference</button>
    </div>
  </div>
</div>

<div class="modal-overlay" id="modal-addCode">
  <div class="modal">
    <h3>Add Code</h3>
    <label>Code Name</label>
    <input type="text" id="new-code-name" placeholder="e.g., Economic stagnation">
    <label>Parent Code (optional)</label>
    <select id="new-code-parent"><option value="">‚Äî Top Level ‚Äî</option></select>
    <label>Color</label>
    <div class="color-options">
      <div class="color-opt c-purple selected" data-color="purple" onclick="selectColor(this)"></div>
      <div class="color-opt c-green" data-color="green" onclick="selectColor(this)"></div>
      <div class="color-opt c-orange" data-color="orange" onclick="selectColor(this)"></div>
      <div class="color-opt c-pink" data-color="pink" onclick="selectColor(this)"></div>
      <div class="color-opt c-teal" data-color="teal" onclick="selectColor(this)"></div>
      <div class="color-opt c-yellow" data-color="yellow" onclick="selectColor(this)"></div>
    </div>
    <label>Description / Memo</label>
    <textarea id="new-code-desc" rows="3" placeholder="What does this code capture?"></textarea>
    <div class="btn-row">
      <button class="btn btn-ghost" onclick="closeModal('addCode')">Cancel</button>
      <button class="btn btn-primary" onclick="addCode()">Create Code</button>
    </div>
  </div>
</div>

<div class="modal-overlay" id="modal-newMemo">
  <div class="modal">
    <h3>New Memo</h3>
    <label>Title</label>
    <input type="text" id="new-memo-title" placeholder="Memo title‚Ä¶">
    <label>Content</label>
    <textarea id="new-memo-content" rows="5" placeholder="Research note, observation, or theoretical memo‚Ä¶"></textarea>
    <label>Type</label>
    <select id="new-memo-type">
      <option value="free">Free Memo</option>
      <option value="code">Code Memo</option>
      <option value="doc">Document Memo</option>
      <option value="project">Project Memo</option>
    </select>
    <div class="btn-row">
      <button class="btn btn-ghost" onclick="closeModal('newMemo')">Cancel</button>
      <button class="btn btn-primary" onclick="addMemo()">Save Memo</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
// STATE
let state = { documents:[], codes:[], segments:[], memos:[], sets:['Usable Sources','Background'], activeDoc:null, activeCode:null, selectedColor:'purple' };

function loadState() {
  try { const s = localStorage.getItem('researchos2'); if(s) state = {...state,...JSON.parse(s)}; } catch(e){}
}
function saveState() {
  try { localStorage.setItem('researchos2', JSON.stringify({documents:state.documents,codes:state.codes,segments:state.segments,memos:state.memos,sets:state.sets})); } catch(e){}
}

function seedData() {
  if (state.documents.length > 0) return;
  state.codes = [
    {id:'c1',name:'Claim 1: Geopolitical instability ‚Üí mental health',color:'purple',parent:null,desc:'Core claim linking macro-level instability to psychological outcomes',segments:0},
    {id:'c1a',name:'Economic stagnation',color:'purple',parent:'c1',desc:'',segments:3},
    {id:'c1b',name:'Political violence',color:'orange',parent:'c1',desc:'',segments:1},
    {id:'c2',name:'Uncertainty ‚Üí reduced control (Claim 2)',color:'teal',parent:null,desc:'Intolerance of uncertainty predicts certainty-seeking or shutdown',segments:0},
    {id:'c3',name:'Reduced control ‚Üí procrastination (Claim 3)',color:'green',parent:null,desc:'Avoidance as rational coping when control is low',segments:0},
    {id:'c4',name:'Procrastination as rational coping (Claim 4)',color:'yellow',parent:null,desc:'',segments:0},
  ];
  state.documents = [
    {id:'d1',title:'GIP-web',type:'web',set:'Usable Sources',segments:3,content:`<h1>Global Instability Report</h1><h2>Debt and Development</h2><p>Developing countries spending over 10 per cent of their annual revenue on servicing interest on debt face significant challenges that directly impact global peace and security. This financial burden limits their ability to invest in critical sectors such as healthcare, education, and infrastructure, exacerbating poverty and inequality.</p><p>The strain also undermines state capacity to address grievances, fuelling public dissatisfaction and creating fertile ground for social unrest, political instability, and violent conflict. Furthermore, these fiscal constraints often force reliance on external creditors, increasing geopolitical dependencies that can heighten tensions and erode national sovereignty.</p><p>The inability of these countries to achieve sustainable development amidst such financial pressure not only destabilises their regions but also has spillover effects, including <span class="highlight">migration crises</span> and the spread of transnational threats, making this issue a priority for maintaining global stability.</p><h2>Mental Health Implications</h2><p>Research consistently demonstrates that populations living under conditions of <span class="highlight orange">geopolitical uncertainty experience elevated rates of anxiety, depression, and post-traumatic stress</span>. The chronic nature of this stress differs meaningfully from acute trauma responses and requires distinct clinical and policy frameworks.</p>`},
    {id:'d2',title:'Kruglanski et al., 2024',type:'pdf',set:'Usable Sources',segments:0,content:`<h1>Kruglanski et al., 2024</h1><p>Past negative experiences (adverse childhood events, ecological threats) predict negative affective reactions to uncertain events; people interpret uncertain futures through the lens of prior outcomes (optimism/pessimism).</p><p>Intolerance of uncertainty predicts certainty-seeking behaviors (seizing/freezing, joining rigid groups, compulsive checking). High IU leads people to seek certainty ‚Äî or shut down when certainty is unavailable.</p><p>Negative affective reactions to uncertainty lead to escape/avoidance behaviors, not approach. High need for closure leads to 'seizing and freezing' on available certainties.</p>`},
    {id:'d3',title:'Chaaya et al., 2025',type:'pdf',set:'Usable Sources',segments:0,content:`<h1>Chaaya et al., 2025</h1><p>82% of Lebanese university students reported high levels of uncertainty during accumulated crises (economic collapse, COVID-19, Beirut blast); political instability linked to loneliness, stress, and anxiety disrupting academic and social life.</p><p>High intolerance of uncertainty (IU) found in 82% of sample. IU consistently predicted lower adaptive coping across all regression models ‚Äî uncertainty strips coping capacity.</p><p>Students changed their plans due to crises; women disproportionately impacted by economic crisis, affecting future career and education plans specifically.</p>`},
    {id:'d4',title:'Kowalski, 2025',type:'pdf',set:'Usable Sources',segments:0,content:`<h1>Kowalski, 2025</h1><p>Contemporary geopolitical system marked by overlapping crises ‚Äî great-power competition, climate stress, economic fragmentation, rapid tech change ‚Äî creating sustained psychological uncertainty for populations.</p><p>Reduced predictability is core feature of geopolitical disruption; resilient actors maintain 'strategic direction' under uncertainty, implying non-resilient actors lose direction and predictability.</p><p>Building geopolitical resilience requires 'difficult trade-offs'; uncertainty leads states to prefer short-term stability over long-term planning.</p>`},
  ];
  state.segments = [
    {id:'s1',docId:'d1',text:'migration crises and the spread of transnational threats',codeId:'c1a',color:'purple',note:'Shows how debt-driven instability creates cross-border effects',type:'quote',date:new Date().toLocaleDateString()},
    {id:'s2',docId:'d1',text:'geopolitical uncertainty experience elevated rates of anxiety, depression, and post-traumatic stress',codeId:'c1a',color:'orange',note:'Direct empirical link ‚Äî key evidence for Claim 1',type:'quote',date:new Date().toLocaleDateString()},
  ];
  state.memos = [
    {id:'m1',title:'Opening argument structure',content:'Frame the introduction around the paradox: global economic integration was supposed to bring stability, yet mental health crises are rising ‚Äî particularly among Gen Z who face a "polycrisis" with no recovery periods.',type:'free',date:new Date().toLocaleDateString()},
    {id:'m2',title:'Synthesis across Claim 2 sources',content:'All three papers converge: Kruglanski provides the psychological mechanism (IU ‚Üí avoidance), Chaaya provides empirical proof (82% IU in Lebanese students), Kowalski contextualises at macro level. Together they build an airtight pathway.',type:'free',date:new Date().toLocaleDateString()},
  ];
  saveState();
}

const colorMap = {purple:'var(--accent)',green:'var(--green)',orange:'var(--orange)',pink:'var(--pink)',teal:'var(--teal)',yellow:'var(--yellow)'};
function typeColor(t){return{quote:'var(--accent)',paraphrase:'var(--green)',synthesis:'var(--teal)',figure:'var(--yellow)',counter:'var(--pink)'}[t]||'var(--accent)';}
function typeLabel(t){return{quote:'Direct Quote',paraphrase:'Paraphrase',synthesis:'Synthesis',figure:'Figure/Data',counter:'Counter-evidence'}[t]||t||'Quote';}

function renderAll(){renderDocs();renderCodes();renderSegments();renderMemos();renderAnalysis();updateStatus();populateSelects();}

function renderDocs(filter=''){
  const el=document.getElementById('doc-list');
  let html='';
  const ungrouped=state.documents.filter(d=>!d.set&&(!filter||d.title.toLowerCase().includes(filter)));
  ungrouped.forEach(d=>{html+=docItem(d);});
  const usedSets=[...new Set(state.documents.map(d=>d.set).filter(Boolean))];
  usedSets.forEach(set=>{
    const docs=state.documents.filter(d=>d.set===set&&(!filter||d.title.toLowerCase().includes(filter)));
    if(!docs.length)return;
    html+=`<div class="set-header" onclick="toggleSet(this)"><span class="set-dot"></span><span class="set-arrow open">‚ñ∂</span><span class="set-name">${set}</span><span style="font-size:10px;color:var(--text3);font-family:'DM Mono',monospace">${docs.length}</span></div><div class="set-children">`;
    docs.forEach(d=>{html+=docItem(d);});
    html+='</div>';
  });
  el.innerHTML=html||'<div class="empty"><div class="emoji">üì≠</div>No documents yet.<br>Click Import ‚Üí New Doc</div>';
}

function docItem(d){
  const icon=d.type==='web'?'üåê':d.type==='book'?'üìö':d.type==='note'?'üìù':'üìÑ';
  const active=state.activeDoc?.id===d.id?'active':'';
  const segs=state.segments.filter(s=>s.docId===d.id).length;
  return `<div class="doc-item ${active}" onclick="openDoc('${d.id}')"><span class="doc-icon">${icon}</span><div class="doc-info"><div class="doc-name">${d.title}</div><div class="doc-meta">${d.type?.toUpperCase()||'DOC'}</div></div>${segs?`<span class="doc-count">${segs}</span>`:''}</div>`;
}

function renderCodes(){
  const el=document.getElementById('code-list');
  const roots=state.codes.filter(c=>!c.parent);
  if(!roots.length){el.innerHTML='<div class="empty"><div class="emoji">üè∑Ô∏è</div>No codes yet.</div>';return;}
  let html='';
  roots.forEach(c=>{
    const n=state.segments.filter(s=>s.codeId===c.id).length;
    const active=state.activeCode?.id===c.id?'active':'';
    html+=`<div class="code-item ${active}" onclick="selectCode('${c.id}')"><div class="code-dot" style="background:${colorMap[c.color]||colorMap.purple}"></div><span class="code-name">${c.name}</span><span class="code-n">${n}</span></div>`;
    state.codes.filter(s=>s.parent===c.id).forEach(sub=>{
      const sn=state.segments.filter(s=>s.codeId===sub.id).length;
      const sa=state.activeCode?.id===sub.id?'active':'';
      html+=`<div class="code-item sub ${sa}" onclick="selectCode('${sub.id}')"><div class="code-dot" style="background:${colorMap[sub.color]||colorMap.purple};opacity:0.7"></div><span class="code-name">${sub.name}</span><span class="code-n">${sn}</span></div>`;
    });
  });
  el.innerHTML=html;
  populateCodeParentSelect();
}

function renderSegments(){
  const el=document.getElementById('segments-list');
  if(!state.segments.length){el.innerHTML='<div class="empty"><div class="emoji">‚úÇÔ∏è</div>No coded segments yet.</div>';return;}
  let html='';
  state.segments.forEach(seg=>{
    const code=state.codes.find(c=>c.id===seg.codeId);
    const doc=state.documents.find(d=>d.id===seg.docId);
    const col=colorMap[seg.color]||colorMap.purple;
    const tc=typeColor(seg.type);
    html+=`<div class="segment" onclick="openDoc('${seg.docId}')">
      <div style="display:flex;gap:4px;align-items:center;margin-bottom:4px;flex-wrap:wrap;">
        <span class="segment-code-tag" style="background:${tc}22;color:${tc};font-size:9.5px;padding:1px 5px;border-radius:8px">${typeLabel(seg.type)}</span>
        ${code?`<span class="segment-code-tag" style="background:${col}22;color:${col}">${code.name}</span>`:''}
      </div>
      <div class="segment-text">"${seg.text}"</div>
      ${seg.note?`<div style="font-size:11px;color:var(--text);margin-top:4px;padding:4px 8px;background:var(--surface2);border-radius:5px;line-height:1.4;">üìù ${seg.note}</div>`:''}
      <div class="segment-meta"><span>${doc?.title||''}</span>${seg.date?`<span>${seg.date}</span>`:''}</div>
    </div>`;
  });
  el.innerHTML=html;
}

function renderMemos(){
  const el=document.getElementById('memos-list');
  if(!state.memos.length){el.innerHTML='<div class="empty"><div class="emoji">üìù</div>No memos yet.</div>';return;}
  let html='';
  state.memos.forEach(m=>{
    const typeColors={free:'var(--green)',code:'var(--accent)',doc:'var(--orange)',project:'var(--teal)'};
    const col=typeColors[m.type]||typeColors.free;
    html+=`<div class="segment"><div style="font-size:12px;font-weight:500;color:var(--text);margin-bottom:4px;">${m.title}</div><div class="segment-text">${m.content}</div><div class="segment-meta"><span class="segment-code-tag" style="background:${col}22;color:${col}">${m.type}</span><span>${m.date||''}</span></div></div>`;
  });
  el.innerHTML=html;
}

function renderAnalysis(){
  const el=document.getElementById('analysis-content');
  const codeCounts=state.codes.map(c=>({name:c.name.substring(0,22),count:state.segments.filter(s=>s.codeId===c.id).length,color:colorMap[c.color]||colorMap.purple})).filter(c=>c.count>0).sort((a,b)=>b.count-a.count);
  const maxCount=Math.max(...codeCounts.map(c=>c.count),1);
  let html=`<div class="analysis-card"><div class="analysis-title">üìä Code Frequencies</div>`;
  if(!codeCounts.length){html+='<div style="color:var(--text3);font-size:12px;text-align:center;padding:10px;">No coded segments yet</div>';}
  else{codeCounts.forEach(c=>{html+=`<div class="bar-row"><div class="bar-label" title="${c.name}">${c.name}</div><div class="bar-track"><div class="bar-fill" style="width:${(c.count/maxCount*100)}%;background:${c.color}"></div></div><div class="bar-count">${c.count}</div></div>`;});}
  html+=`</div><div class="analysis-card"><div class="analysis-title">üìÑ Overview</div>
    <div class="bar-row"><div class="bar-label">Documents</div><div class="bar-count" style="width:auto">${state.documents.length}</div></div>
    <div class="bar-row"><div class="bar-label">Segments</div><div class="bar-count" style="width:auto">${state.segments.length}</div></div>
    <div class="bar-row"><div class="bar-label">Codes</div><div class="bar-count" style="width:auto">${state.codes.length}</div></div>
    <div class="bar-row"><div class="bar-label">Memos</div><div class="bar-count" style="width:auto">${state.memos.length}</div></div>
  </div>`;
  el.innerHTML=html;
}

function updateStatus(){
  document.getElementById('st-docs').textContent=`${state.documents.length} doc${state.documents.length!==1?'s':''}`;
  document.getElementById('st-codes').textContent=`${state.codes.length} codes`;
  document.getElementById('st-segments').textContent=`${state.segments.length} segments`;
  document.getElementById('st-memos').textContent=`${state.memos.length} memos`;
}

function populateSelects(){
  ['new-doc-set','import-file-set','web-import-set'].forEach(id=>{
    const sel=document.getElementById(id);if(!sel)return;
    sel.innerHTML='<option value="">‚Äî No Set ‚Äî</option>';
    state.sets.forEach(s=>sel.innerHTML+=`<option value="${s}">${s}</option>`);
  });
  populateCodeParentSelect();
}

function populateCodeParentSelect(){
  const sel=document.getElementById('new-code-parent');
  sel.innerHTML='<option value="">‚Äî Top Level ‚Äî</option>';
  state.codes.filter(c=>!c.parent).forEach(c=>{sel.innerHTML+=`<option value="${c.id}">${c.name}</option>`;});
}

function openDoc(id){
  state.activeDoc=state.documents.find(d=>d.id===id);
  if(!state.activeDoc)return;
  document.getElementById('viewer-empty').style.display='none';
  document.getElementById('viewer-doc-label').textContent=state.activeDoc.title;
  document.getElementById('viewer-content').innerHTML=state.activeDoc.content||'<p style="color:var(--text3)">No content.</p>';
  renderDocs();
}

// SELECTION & HIGHLIGHT
let selRange=null;
function handleSelection(e){
  const sel=window.getSelection();
  if(!sel||sel.toString().trim().length<3){hideSelToolbar();return;}
  selRange=sel.getRangeAt(0);
  const rect=sel.getRangeAt(0).getBoundingClientRect();
  const tb=document.getElementById('sel-toolbar');
  tb.style.top=(rect.top+window.scrollY-44)+'px';
  tb.style.left=(rect.left+rect.width/2-80)+'px';
  tb.classList.add('show');
}
function hideSelToolbar(){document.getElementById('sel-toolbar').classList.remove('show');selRange=null;}

let pendingSegment=null;
function applyHighlight(type){
  if(!selRange)return;
  if(!state.activeDoc){toast('Select a document first');hideSelToolbar();return;}
  const selectedText=selRange.toString().trim();
  if(!selectedText)return;
  const code=state.activeCode;
  const codeId=code?code.id:(state.codes[0]?state.codes[0].id:null);
  const color=type==='purple'?(code?.color||'purple'):type;
  let span;
  try{
    span=document.createElement('span');
    span.className=`highlight ${type==='green'?'green':type==='orange'?'orange':''}`;
    span.title=code?code.name:'Marked';
    selRange.surroundContents(span);
  }catch(e){toast('Select within a single paragraph');hideSelToolbar();return;}
  hideSelToolbar();
  window.getSelection().removeAllRanges();
  pendingSegment={id:'s'+Date.now(),docId:state.activeDoc.id,text:selectedText.substring(0,500),codeId,color,note:'',type:type==='green'?'quote':type==='orange'?'synthesis':'quote',docTitle:state.activeDoc.title,codeName:code?.name||'',date:new Date().toLocaleDateString(),span};
  const rect=span.getBoundingClientRect();
  const popup=document.getElementById('seg-popup');
  document.getElementById('seg-popup-quote').textContent='"'+selectedText.substring(0,140)+(selectedText.length>140?'‚Ä¶':'')+'"';
  document.getElementById('seg-popup-note').value='';
  document.getElementById('seg-popup-type').value=pendingSegment.type;
  let top=rect.bottom+window.scrollY+8,left=rect.left+window.scrollX;
  if(left+320>window.innerWidth)left=window.innerWidth-330;
  if(top+200>window.innerHeight+window.scrollY)top=rect.top+window.scrollY-210;
  popup.style.top=top+'px';popup.style.left=left+'px';popup.style.display='block';
  setTimeout(()=>document.getElementById('seg-popup-note').focus(),50);
}

function confirmSegment(){
  if(!pendingSegment)return;
  pendingSegment.note=document.getElementById('seg-popup-note').value.trim();
  pendingSegment.type=document.getElementById('seg-popup-type').value;
  delete pendingSegment.span;
  state.segments.push(pendingSegment);
  const c=state.codes.find(c=>c.id===pendingSegment.codeId);if(c)c.segments=(c.segments||0)+1;
  if(state.activeDoc)state.activeDoc.segments=(state.activeDoc.segments||0)+1;
  saveState();renderAll();
  toast('‚úì Segment saved'+(pendingSegment.note?' with note':''));
  pendingSegment=null;document.getElementById('seg-popup').style.display='none';
}

function cancelSegment(){
  if(pendingSegment?.span){const sp=pendingSegment.span,par=sp.parentNode;if(par){while(sp.firstChild)par.insertBefore(sp.firstChild,sp);par.removeChild(sp);}}
  pendingSegment=null;document.getElementById('seg-popup').style.display='none';
}

document.addEventListener('keydown',e=>{if(e.key==='Escape'&&document.getElementById('seg-popup').style.display==='block')cancelSegment();});

// ACTIONS
function addDocument(){
  const title=document.getElementById('new-doc-title').value.trim();
  const content=document.getElementById('new-doc-content').value.trim();
  const type=document.getElementById('new-doc-type').value;
  const set=document.getElementById('new-doc-set').value;
  if(!title){toast('Please enter a title');return;}
  const doc={id:'d'+Date.now(),title,type,set,content:content?`<h1>${title}</h1><p>${content.replace(/\n\n/g,'</p><p>').replace(/\n/g,'<br>')}</p>`:`<h1>${title}</h1><p style="color:var(--text3)">No content added yet.</p>`,segments:0};
  state.documents.push(doc);saveState();renderAll();closeModal('newDoc');
  document.getElementById('new-doc-title').value='';document.getElementById('new-doc-content').value='';
  toast('Document added: '+title);openDoc(doc.id);
}

function addCode(){
  const name=document.getElementById('new-code-name').value.trim();
  const parent=document.getElementById('new-code-parent').value;
  const desc=document.getElementById('new-code-desc').value.trim();
  if(!name){toast('Please enter a code name');return;}
  const code={id:'c'+Date.now(),name,parent:parent||null,color:state.selectedColor,desc,segments:0};
  state.codes.push(code);saveState();renderAll();closeModal('addCode');
  document.getElementById('new-code-name').value='';document.getElementById('new-code-desc').value='';
  toast('Code created: '+name);
}

function addMemo(){
  const title=document.getElementById('new-memo-title').value.trim();
  const content=document.getElementById('new-memo-content').value.trim();
  const type=document.getElementById('new-memo-type').value;
  if(!title||!content){toast('Please fill in title and content');return;}
  state.memos.push({id:'m'+Date.now(),title,content,type,date:new Date().toLocaleDateString()});
  saveState();renderAll();closeModal('newMemo');
  document.getElementById('new-memo-title').value='';document.getElementById('new-memo-content').value='';
  toast('Memo saved');
}

function saveCodeMemo(){
  if(!state.activeCode){toast('Select a code first');return;}
  state.activeCode.desc=document.getElementById('code-memo-input').value;
  saveState();toast('Code memo saved');
}

function selectCode(id){
  state.activeCode=state.codes.find(c=>c.id===id);
  renderCodes();
  if(state.activeCode){
    document.getElementById('code-memo-input').value=state.activeCode.desc||'';
    document.getElementById('active-code-badge').textContent=state.activeCode.name;
  }
}

function selectColor(el){
  document.querySelectorAll('.color-opt').forEach(e=>e.classList.remove('selected'));
  el.classList.add('selected');state.selectedColor=el.dataset.color;
}

function toggleSet(el){
  const arrow=el.querySelector('.set-arrow'),children=el.nextElementSibling;
  if(children)children.style.display=children.style.display==='none'?'':'none';
  arrow.classList.toggle('open');
}

function filterDocs(val){renderDocs(val.toLowerCase());}

// REPORT SYSTEM
function escHtml(str){if(!str)return'';return str.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');}

function showReportView(type){
  document.getElementById('main-layout').style.display='none';
  const rv=document.getElementById('report-view');rv.style.display='flex';rv.style.flexDirection='column';
  const titles={matrix:'FINDINGS MATRIX',bycode:'BY CODE / CLAIM',bydoc:'BY DOCUMENT',memos:'MEMOS & NOTES'};
  document.getElementById('report-view-title').textContent=titles[type]||'REPORT';
  document.getElementById('report-content').innerHTML=buildReport(type);
  document.getElementById('report-counts').textContent=`${state.segments.length} segments ¬∑ ${state.memos.length} memos ¬∑ ${state.documents.length} docs`;
}

function closeReportView(){
  document.getElementById('report-view').style.display='none';
  document.getElementById('main-layout').style.display='grid';
}

function buildReport(type){
  const now=new Date().toLocaleDateString('en-GB',{day:'numeric',month:'long',year:'numeric'});
  let html=`<div class="report-h1">Research Report</div><div class="report-meta">Generated ${now} ¬∑ ${state.documents.length} documents ¬∑ ${state.segments.length} segments ¬∑ ${state.codes.length} codes ¬∑ ${state.memos.length} memos</div>`;
  if(type==='matrix')html+=buildMatrixReport();
  else if(type==='bycode')html+=buildByCodeReport();
  else if(type==='bydoc')html+=buildByDocReport();
  else if(type==='memos')html+=buildMemosReport();
  return html;
}

function segCard(seg,showCode=true){
  const code=state.codes.find(c=>c.id===seg.codeId);
  const doc=state.documents.find(d=>d.id===seg.docId);
  const col=colorMap[seg.color]||'var(--accent)';
  const tc=typeColor(seg.type);const tl=typeLabel(seg.type);
  return `<div class="seg-card">
    <div class="seg-card-header">
      <span class="seg-type-badge" style="background:${tc}22;color:${tc}">${tl}</span>
      ${showCode&&code?`<span style="color:var(--accent2)">üè∑ ${escHtml(code.name)}</span>`:''}
      <span>üìÑ ${escHtml(doc?.title||'Unknown')}</span>
      ${seg.date?`<span style="margin-left:auto">${seg.date}</span>`:''}
    </div>
    <div class="seg-quote ${seg.color==='green'?'green':seg.color==='orange'?'orange':''}">"${escHtml(seg.text)}"</div>
    ${seg.note?`<div class="seg-note"><div class="seg-note-label">üìù Your note / paraphrase</div><div>${escHtml(seg.note)}</div></div>`:''}
  </div>`;
}

function buildByCodeReport(){
  if(!state.codes.length)return'<p class="no-segs-notice">No codes created yet.</p>';
  let html='';
  state.codes.filter(c=>!c.parent).forEach(code=>{
    const col=colorMap[code.color]||'var(--accent)';
    const segs=state.segments.filter(s=>s.codeId===code.id);
    const subCodes=state.codes.filter(c=>c.parent===code.id);
    const allSubSegs=subCodes.flatMap(sc=>state.segments.filter(s=>s.codeId===sc.id));
    html+=`<div class="report-section"><div class="report-claim"><div class="report-claim-dot" style="background:${col}"></div>${escHtml(code.name)}<span style="font-size:12px;color:var(--text3);font-weight:400;margin-left:8px">(${segs.length+allSubSegs.length})</span></div>${code.desc?`<div class="report-code-desc">${escHtml(code.desc)}</div>`:''}`;
    if(segs.length)html+=segs.map(s=>segCard(s,false)).join('');
    subCodes.forEach(sub=>{
      const subSegs=state.segments.filter(s=>s.codeId===sub.id);
      const subCol=colorMap[sub.color]||col;
      html+=`<div style="margin-left:20px;margin-top:12px;"><div style="font-size:13px;font-weight:500;color:var(--text2);margin-bottom:8px;display:flex;align-items:center;gap:8px;"><div style="width:8px;height:8px;border-radius:2px;background:${subCol};opacity:0.7"></div>${escHtml(sub.name)} <span style="font-size:11px;color:var(--text3)">(${subSegs.length})</span></div>${subSegs.length?subSegs.map(s=>segCard(s,false)).join(''):'<p class="no-segs-notice">No segments yet.</p>'}</div>`;
    });
    if(!segs.length&&!allSubSegs.length)html+='<p class="no-segs-notice">No segments coded under this claim yet.</p>';
    html+='</div>';
  });
  return html;
}

function buildByDocReport(){
  if(!state.documents.length)return'<p class="no-segs-notice">No documents yet.</p>';
  let html='';
  state.documents.forEach(doc=>{
    const segs=state.segments.filter(s=>s.docId===doc.id);
    const icon=doc.type==='web'?'üåê':doc.type==='book'?'üìö':'üìÑ';
    html+=`<div class="report-section"><div class="report-claim" style="font-size:16px;">${icon} ${escHtml(doc.title)}<span style="font-size:12px;color:var(--text3);font-weight:400;margin-left:8px">(${segs.length})</span></div>`;
    html+=segs.length?segs.map(s=>segCard(s,true)).join(''):'<p class="no-segs-notice">No segments coded from this document yet.</p>';
    html+='</div>';
  });
  return html;
}

function buildMemosReport(){
  let html='';
  if(state.memos.length){
    html+=`<div class="report-section-heading">üìù Memos & Research Notes</div>`;
    state.memos.forEach(m=>{
      const typeColors={free:'var(--green)',code:'var(--accent)',doc:'var(--orange)',project:'var(--teal)'};
      const col=typeColors[m.type]||'var(--green)';
      html+=`<div class="memo-card"><div class="memo-card-title">${escHtml(m.title)} <span style="font-size:10px;color:${col};font-family:'DM Mono',monospace;margin-left:6px;background:${col}22;padding:2px 7px;border-radius:10px;">${m.type}</span></div><div class="memo-card-body">${escHtml(m.content)}</div>${m.date?`<div style="font-size:10.5px;color:var(--text3);margin-top:6px;font-family:'DM Mono',monospace">${m.date}</div>`:''}</div>`;
    });
  }
  const codeMemos=state.codes.filter(c=>c.desc);
  if(codeMemos.length){
    html+=`<div class="report-section-heading">üè∑Ô∏è Code Memos</div>`;
    codeMemos.forEach(c=>{const col=colorMap[c.color]||'var(--accent)';html+=`<div class="memo-card" style="border-left:3px solid ${col}"><div class="memo-card-title">${escHtml(c.name)}</div><div class="memo-card-body">${escHtml(c.desc)}</div></div>`;});
  }
  if(!state.memos.length&&!codeMemos.length)html+='<p class="no-segs-notice">No memos yet.</p>';
  return html;
}

function buildMatrixReport(){
  const docs=state.documents;
  if(!docs.length||!state.codes.length)return'<p class="no-segs-notice">Add documents and codes first, then highlight segments to populate the matrix.</p>';
  const roots=state.codes.filter(c=>!c.parent);
  let html=`<div class="report-section-heading">üìä Findings Matrix ‚Äî Segments by Claim √ó Source</div><div style="overflow-x:auto;margin-bottom:32px;"><table class="report-matrix-table"><thead><tr><th style="min-width:140px">Claim / Code</th>${docs.map(d=>`<th style="min-width:120px">${escHtml(d.title)}</th>`).join('')}<th style="min-width:120px;background:var(--accent)11;color:var(--accent2)">Synthesis</th></tr></thead><tbody>`;
  roots.forEach(code=>{
    const col=colorMap[code.color]||'var(--accent)';
    const subCodes=state.codes.filter(c=>c.parent===code.id);
    const allCodeIds=[code.id,...subCodes.map(s=>s.id)];
    const allSegs=state.segments.filter(s=>allCodeIds.includes(s.codeId));
    const synthText=[code.desc,...allSegs.filter(s=>s.type==='synthesis').map(s=>s.note||s.text)].filter(Boolean).join(' ¬∑ ');
    html+=`<tr><td class="claim-cell" style="border-left:3px solid ${col}"><div style="display:flex;align-items:center;gap:6px;"><div style="width:8px;height:8px;border-radius:2px;background:${col};flex-shrink:0"></div><span>${escHtml(code.name)}</span></div></td>${docs.map(doc=>{
      const docSegs=allSegs.filter(s=>s.docId===doc.id);
      if(!docSegs.length)return`<td style="color:var(--text3);font-size:11px;font-style:italic;">‚Äî</td>`;
      return`<td>${docSegs.map(s=>`<div style="margin-bottom:8px;">${s.note?`<div style="font-size:12px;color:var(--text);margin-bottom:4px;">${escHtml(s.note)}</div>`:''}<div style="font-size:11px;color:var(--text3);font-style:italic;border-left:2px solid ${colorMap[s.color]||'var(--accent)'};padding-left:6px;">"${escHtml(s.text.substring(0,100))}${s.text.length>100?'‚Ä¶':''}"</div></div>`).join('')}</td>`;
    }).join('')}<td style="background:var(--accent)06;font-size:12px;color:var(--text2);">${escHtml(synthText)||'<span style="color:var(--text3);font-style:italic">‚Äî</span>'}</td></tr>`;
  });
  html+=`</tbody></table></div>`;
  if(state.segments.length){html+=`<div class="report-section-heading">üìé All Coded Segments</div>`;html+=state.segments.map(s=>segCard(s,true)).join('');}
  if(state.memos.length){html+=`<div class="report-section-heading">üìù Memos</div>`;state.memos.forEach(m=>{html+=`<div class="memo-card"><div class="memo-card-title">${escHtml(m.title)}</div><div class="memo-card-body">${escHtml(m.content)}</div></div>`;});}
  return html;
}

function exportReportHTML(){
  if(!document.getElementById('report-view').style.display||document.getElementById('report-view').style.display==='none'){showReportView('matrix');}
  const content=document.getElementById('report-content').innerHTML;
  const w=window.open('','_blank');
  w.document.write(`<!DOCTYPE html><html><head><meta charset="UTF-8"><title>Research Report</title><style>body{font-family:system-serif,Georgia,serif;background:#0f0f13;color:#e8e8f0;padding:40px;max-width:900px;margin:0 auto;}:root{--accent:#7c6af7;--accent2:#a594ff;--green:#4caf8a;--orange:#e8834a;--pink:#e06b8b;--teal:#4ab8c8;--yellow:#d4b84a;--surface:#17171f;--surface2:#1e1e2a;--border:#2a2a3d;--text:#e8e8f0;--text2:#9090a8;--text3:#5a5a72;}.report-h1{font-size:26px;font-weight:600;color:var(--text);margin-bottom:6px;}.report-meta{font-size:11px;color:var(--text3);margin-bottom:28px;padding-bottom:16px;border-bottom:1px solid var(--border);}.seg-card{background:var(--surface);border:1px solid var(--border);border-radius:10px;margin-bottom:14px;overflow:hidden;}.seg-card-header{padding:8px 14px;background:var(--surface2);display:flex;align-items:center;gap:8px;font-size:11px;color:var(--text3);}.seg-type-badge{padding:2px 8px;border-radius:10px;font-size:10px;font-weight:500;text-transform:uppercase;}.seg-quote{padding:12px 14px;font-style:italic;color:var(--text2);font-size:13px;line-height:1.65;border-left:3px solid var(--accent);margin:12px 14px;background:var(--surface2);border-radius:0 8px 8px 0;}.seg-note{padding:10px 14px 12px;font-size:13px;color:var(--text);line-height:1.6;}.seg-note-label{font-size:10px;color:var(--text3);text-transform:uppercase;margin-bottom:4px;}.memo-card{background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:14px;margin-bottom:12px;}.memo-card-title{font-weight:500;font-size:13px;color:var(--text);margin-bottom:6px;}.memo-card-body{font-size:12.5px;color:var(--text2);line-height:1.6;}.report-section-heading{font-size:15px;font-weight:600;color:var(--text2);margin:24px 0 10px;padding-bottom:6px;border-bottom:1px solid var(--border);}.report-section{margin-bottom:40px;}.report-claim{font-size:17px;font-weight:600;color:var(--text);margin-bottom:6px;padding-bottom:8px;border-bottom:2px solid var(--border);display:flex;align-items:center;gap:10px;}.report-claim-dot{width:12px;height:12px;border-radius:3px;flex-shrink:0;}.no-segs-notice{color:var(--text3);font-size:12px;font-style:italic;padding:10px 0;}table{width:100%;border-collapse:collapse;font-size:12px;}th{background:var(--surface2);padding:8px 10px;text-align:left;color:var(--text2);border:1px solid var(--border);font-weight:500;}td{padding:8px 10px;border:1px solid var(--border);color:var(--text2);vertical-align:top;line-height:1.55;}</style></head><body>${content}</body></html>`);
  w.document.close();setTimeout(()=>w.print(),400);
}

function exportReportMD(){
  const now=new Date().toLocaleDateString();
  const lines=[`# Research Report\n*${now} ¬∑ ${state.documents.length} docs ¬∑ ${state.segments.length} segments*\n\n`];
  lines.push('## Findings by Code / Claim\n\n');
  state.codes.filter(c=>!c.parent).forEach(code=>{
    lines.push(`### ${code.name}\n`);
    if(code.desc)lines.push(`*${code.desc}*\n\n`);
    const segs=state.segments.filter(s=>s.codeId===code.id);
    segs.forEach(s=>{
      const doc=state.documents.find(d=>d.id===s.docId);
      lines.push(`> "${s.text}"\n‚Äî *${doc?.title||'Unknown'}* [${typeLabel(s.type)}]\n\n`);
      if(s.note)lines.push(`**Note:** ${s.note}\n\n`);
    });
    state.codes.filter(c=>c.parent===code.id).forEach(sub=>{
      lines.push(`#### ${sub.name}\n`);
      state.segments.filter(s=>s.codeId===sub.id).forEach(s=>{
        const doc=state.documents.find(d=>d.id===s.docId);
        lines.push(`> "${s.text}"\n‚Äî *${doc?.title||''}* [${typeLabel(s.type)}]\n\n`);
        if(s.note)lines.push(`**Note:** ${s.note}\n\n`);
      });
    });
  });
  if(state.memos.length){lines.push('## Memos\n\n');state.memos.forEach(m=>{lines.push(`### ${m.title}\n${m.content}\n\n`);});}
  const blob=new Blob([lines.join('')],{type:'text/markdown'});
  const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='research-report.md';a.click();
  toast('Report exported as .md');
}

// FILE IMPORT
let importQueue=[];
function triggerFileImport(){importQueue=[];document.getElementById('import-file-list').innerHTML='';document.getElementById('file-input').value='';openModal('fileImport');}
function dropZoneDrag(e,over){e.preventDefault();const dz=document.getElementById('drop-zone');dz.style.borderColor=over?'var(--accent)':'var(--border2)';dz.style.background=over?'rgba(124,106,247,0.05)':'';}
function dropZoneDrop(e){e.preventDefault();dropZoneDrag(e,false);handleFileImport(e.dataTransfer.files);}
function handleFileImport(files){
  if(!files||!files.length)return;
  if(!document.getElementById('modal-fileImport').classList.contains('open')){importQueue=[];document.getElementById('import-file-list').innerHTML='';openModal('fileImport');}
  Array.from(files).forEach(file=>{
    const ext=file.name.split('.').pop().toLowerCase();
    if(ext==='pdf'){importQueue.push({file,name:file.name.replace(/\.[^.]+$/,''),ext,content:null,size:file.size});renderImportQueue();return;}
    const reader=new FileReader();
    reader.onload=e=>{importQueue.push({file,name:file.name.replace(/\.[^.]+$/,''),ext,content:e.target.result,size:file.size});renderImportQueue();};
    reader.readAsText(file);
  });
}
function renderImportQueue(){
  const el=document.getElementById('import-file-list');
  if(!importQueue.length){el.innerHTML='';return;}
  el.innerHTML=importQueue.map((item,i)=>`<div style="display:flex;align-items:center;gap:8px;padding:7px 10px;background:var(--surface2);border-radius:8px;margin-bottom:6px;border:1px solid var(--border)"><span style="font-size:16px">${item.ext==='pdf'?'üìÑ':item.ext==='md'?'üìù':item.ext==='csv'?'üìä':'üìÉ'}</span><div style="flex:1;overflow:hidden"><input style="background:transparent;border:none;color:var(--text);font-family:'DM Sans',sans-serif;font-size:12.5px;width:100%;outline:none" value="${item.name}" onchange="importQueue[${i}].name=this.value"><div style="font-size:10px;color:var(--text3);font-family:'DM Mono',monospace">${item.ext.toUpperCase()} ¬∑ ${(item.size/1024).toFixed(1)} KB${item.content===null?' ¬∑ ‚ö†Ô∏è PDF ‚Äì paste text manually':''}</div></div><button onclick="importQueue.splice(${i},1);renderImportQueue()" style="background:none;border:none;color:var(--text3);cursor:pointer;font-size:16px">‚úï</button></div>`).join('');
}
function clearImportQueue(){importQueue=[];}
function confirmFileImport(){
  if(!importQueue.length){toast('No files queued');return;}
  const set=document.getElementById('import-file-set').value;
  let count=0;
  importQueue.forEach(item=>{
    const raw=item.content||'';
    const paragraphs=raw.split(/\n{2,}/).filter(p=>p.trim()).map(p=>`<p>${p.replace(/\n/g,'<br>')}</p>`).join('')||`<p style="color:var(--text3)">PDF imported ‚Äî paste content below or open original file.</p>`;
    state.documents.push({id:'d'+Date.now()+Math.random().toString(36).slice(2),title:item.name,type:item.ext==='pdf'?'pdf':item.ext==='csv'?'csv':'txt',set,content:`<h1>${item.name}</h1>${paragraphs}`,segments:0});
    count++;
  });
  saveState();renderAll();closeModal('fileImport');clearImportQueue();
  toast(`‚úì Imported ${count} document${count>1?'s':''}`);
  if(state.documents.length)openDoc(state.documents[state.documents.length-1].id);
}
function importFromWeb(){
  const url=document.getElementById('web-import-url').value.trim();
  const title=document.getElementById('web-import-title').value.trim()||url;
  const content=document.getElementById('web-import-content').value.trim();
  const set=document.getElementById('web-import-set').value;
  if(!title&&!url){toast('Enter a URL or title');return;}
  const paragraphs=content.split(/\n{2,}/).filter(p=>p.trim()).map(p=>`<p>${p.replace(/\n/g,'<br>')}</p>`).join('')||`<p style="color:var(--text3)">No content ‚Äî <a href="${url}" target="_blank" style="color:var(--accent2)">${url}</a></p>`;
  const doc={id:'d'+Date.now(),title:title||url,type:'web',set,content:`<h1>${title||url}</h1>${url?`<p style="font-size:11px;color:var(--text3)">üîó <a href="${url}" target="_blank" style="color:var(--accent2)">${url}</a></p>`:''}${paragraphs}`,segments:0};
  state.documents.push(doc);saveState();renderAll();closeModal('importWeb');
  document.getElementById('web-import-url').value='';document.getElementById('web-import-title').value='';document.getElementById('web-import-content').value='';
  toast('Web reference saved');openDoc(doc.id);
}

// NAV & TABS
function switchNav(btn,section){
  document.querySelectorAll('.nav-tab').forEach(b=>b.classList.remove('active'));btn.classList.add('active');
  document.querySelectorAll('[id^="toolbar-"]').forEach(t=>t.style.display='none');
  const tb=document.getElementById('toolbar-'+section);if(tb)tb.style.display='flex';
  if(section==='reports')showReportView('matrix');else closeReportView();
}

function switchRightTab(btn,tab){
  document.querySelectorAll('.panel-tab').forEach(b=>b.classList.remove('active'));btn.classList.add('active');
  const tabs={codes:'right-codes',segments:'right-segments',memos:'right-memos',analysis:'right-analysis'};
  Object.values(tabs).forEach(id=>{const el=document.getElementById(id);if(el)el.style.display='none';});
  const el=document.getElementById(tabs[tab]);if(el)el.style.display='flex';
  if(tab==='analysis')renderAnalysis();if(tab==='segments')renderSegments();if(tab==='memos')renderMemos();
}

// MODALS
function openModal(name){
  document.getElementById('modal-'+name).classList.add('open');
  populateSelects();
}
function closeModal(name){document.getElementById('modal-'+name).classList.remove('open');}
document.querySelectorAll('.modal-overlay').forEach(el=>{el.addEventListener('click',e=>{if(e.target===el)el.classList.remove('open');});});

// TOAST
function toast(msg){const el=document.getElementById('toast');el.textContent=msg;el.classList.add('show');setTimeout(()=>el.classList.remove('show'),2200);}

// INIT
loadState();seedData();renderAll();
if(state.documents.length)openDoc(state.documents[0].id);
</script>
</body>
</html>
